---
title: "COVID19 data exploration"
author: 
- Anass Al AMMIRI
- Ziyad OULHAJ
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
    toc: true # table of content true 
    toc_depth: 2 
---



```{r setup, include=FALSE}
libraries <-c("COVID19", "tidyverse", "skimr", "prettydoc", "rnaturalearth", "sf","tmap" ,"sf", "maps","viridis","readr","ggplot2","rnaturalearth","ggpubr","kableExtra")

list.of.packages <- libraries
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages ,repos ="http://cran.us.r-project.org")

lapply(libraries, library, character.only = TRUE)

world <- map_data("world")
cov19=covid19()
```

# Introduction


Le package COVID 19 (Guidotti, E., Ardia, D., (2020), “COVID-19 Data Hub”, Journal of Open Source Software 5(51):2376, doi: 10.21105/joss.02376) recense des données sur l'épidémie du coronavirus SARS-CoV-2 dans différents pays. Il ajoute à cela des indicateurs géographiques et des indicateurs exogènes pour faciliter l’étude de la pandémie dans sa globalité.
Une présentation des différentes variables du jeu de données est disponible sur https://covid19datahub.io/articles/docs.html.

# Vaccination 

On essayera ici de tirer des conclusions sur l'effet de la vaccination sur la pandémie.

## Nombre de cas en fonction du nombre de personnes vaccinées complétement


```{r }
cov19 %>% select(confirmed,people_fully_vaccinated,date) %>% 
  filter(!is.na(confirmed),!is.na(people_fully_vaccinated)) %>% 
  group_by(date )%>% 
  ggplot(aes(x=people_fully_vaccinated))+
  geom_smooth(aes(y=log(confirmed)),method = 'gam',formula=y~s(x,bs='cs'))
```

La vaccination a un effet de réduction du nombre de cas lorsque le nombre de personnes vaccinées dépasse une certaine jauge. C'est la notion d'immunité collective qui correspond au "pourcentage d’une population donnée qui est immunisée/protégée contre une infection à partir duquel un sujet infecté introduit dans cette population va transmettre le pathogène à moins d’une personne en moyenne, amenant de fait l’épidémie à l’extinction, car le pathogène rencontre trop de sujets protégés" (Institut Pasteur).

## Nombre de cas moyen en fonction de la politique de vaccination des pays
```{r}
cov19 %>% filter(administrative_area_level==1,!is.na(confirmed),!is.na(vaccination_policy)) %>% 
  select(confirmed,vaccination_policy,iso_alpha_3) %>% 
  group_by(iso_alpha_3) %>% 
  summarize(cases=max(confirmed),politique=max(vaccination_policy)) %>% 
  group_by(politique) %>% 
  summarize(cas=mean(cases)) %>% 
  ggplot(aes(x=politique,y=cas))+geom_col()
```


L'indice en abcisse croît avec l'accessibilité du vaccin à une plus grande portion de la population.
On constate que le nombre de cas moyens pour une politique de vaccination universelle pour la population est le plus grand. Ceci peut être expliqué par le fait que les pays qui ont été gravement atteint par la pandémie ont systématiquement mis à disposition des vaccins.

# Mortalité de la pandémie

Le jeu de données nous donne des informations sur le nombre de morts et d'hospitalisations liés à la pandémie.

## Nombre de morts en fonction du nombre de cas
```{r}
cov19 %>% select(deaths,confirmed,date) %>% 
  filter(!is.na(deaths),!is.na(confirmed)) %>% 
  group_by(date )%>% 
  ggplot(aes(x=confirmed,y=deaths))+
  geom_smooth(method='gam',formula=y~s(x,bs="cs"))
```

On remarque qu'il y a une tendance linéaire entre nombre de cas et nombres de morts. Cela correspond au taux de mortalité de la maladie. Essayons de la déterminer par régression linéaire :
```{r mortality rate}
cov19 %>% select(deaths,confirmed,date) %>% 
  filter(!is.na(deaths),!is.na(confirmed)) %>% 
  group_by(date )%>% 
  lm(formula=deaths~confirmed)
```
Le taux de mortalité selon nos données est de 1.762%.

## Nombres de morts et nombre d'hospitalisations en fonction du temps en France
```{r}
cov19 %>%filter(administrative_area_level==1,iso_alpha_3=='FRA') %>% 
  select(hosp,deaths,date) %>% 
  filter(!is.na(hosp),!is.na(deaths)) %>% 
  gather(key=type,value=count,1:2) %>% 
  ggplot(aes(x=date,y=count,color=type))+
  geom_line()
```


Il faut faire attention ici au fait que le nombre de morts est cumulative alors que le nombre d'hospitalisations ne l'est pas. On peut voir sur la figure que la baisse du nombre d'hospitalisation correspond à une croissance moins importante du nombre de morts. Ceci est logique puisqu'un nombre réduit de patients nécessitant une hospitalisation veut dire moins de cas critiques et donc de morts.

# Comparaison des pays à l'égard de la pandémie  

## Vue globale

Pour avoir une vue d'ensemble de la situation de Covid dans le monde entier, nous utilisons différentes cartes, décrivant la situation récente et la situation générale.

```{r,   results='hide', warning=FALSE, message=FALSE}

world_rnatural = rnaturalearth::ne_download(returnclass = "sf")
world_iso = world_rnatural %>% 
  select(NAME_LONG, ISO_A3_EH, POP_EST, CONTINENT)
world_projected = world_iso %>% 
  st_transform("+proj=moll")

```


```{r}
w = dplyr::left_join(world_projected, cov19, by = c("ISO_A3_EH"= "iso_alpha_3"))

#nous n'utilisons pas les données les plus récentes 
#car elles ne sont pas disponibles pour certains pays.
w_30_days_ago = w %>% 
  filter(date == max(date, na.rm = T) - 30)
```

```{r}
plot(w_30_days_ago["deaths"])
```


Nous pouvons constater que certains pays se distinguent des autres. Les États-Unis d'Amérique, par exemple, ont beaucoup plus de cas de décès que les autres, suivis par le Brésil et l'Inde. Viennent ensuite les autres pays avec des variations différentes mais clairement dans une catégorie de décès moins importante.

Si vous essayez de voir une carte similaire mais avec le nombre de cas confirmés :


```{r}
ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "white", fill = "lightgray", size = 0.1
  ) +
  geom_point(
    data = cov19 %>% filter(!is.na(confirmed),administrative_area_level==1,!is.na(longitude),!is.na(latitude)) %>% 
  group_by(iso_alpha_3) %>% 
  summarize(cases=max(confirmed),latitude=max(latitude),longitude=max(longitude)),
    aes(longitude, latitude, color = cases),
    alpha = 0.7
  ) +scale_colour_gradientn(colours=rainbow(4))
```


On remarque ici aussi que les états unis se distingue des autres pays en ce qui concerne le nombre de cas, elle est suivie par l'inde puis le brésil puis d'autres pays européens. 



```{r}
g = st_graticule(w_30_days_ago)
tm_shape(g) +
  tm_lines(col = "grey") +
  tm_shape(w_30_days_ago) +
  tm_polygons(
    c("deaths", "confirmed"),
    palette = "viridis",
    style = "order"
    )  +
  tm_layout(legend.position = c(0.01, 0)) +
  tm_shape(w_30_days_ago) +
  tm_dots(
    col = c("red", "green"),
    size = c("deaths", "confirmed"),
    palette = "viridis"
    )
```



On met de côté les deux cartes précédentes pour avoir des comparaisons plus claires. Pour surmonter le problème de la sous-représentation des petites zones (qui est lié à l'utilisation des cartes choroplèthes), nous utilisons la taille des points comme représentation supplémentaire.





## Classement des 10 pays ayant le plus grand nombre de cas
```{r}
cov19 %>% select(confirmed,iso_alpha_3) %>% 
  filter(!is.na(confirmed)) %>% 
  group_by(iso_alpha_3 )%>% 
  summarise(cases=max(confirmed)) %>% 
  arrange(desc(cases)) %>% 
  head(10) %>% 
  ggplot()+geom_col(aes(x=reorder(iso_alpha_3,cases),y=cases))
```

Ces pays ont tous une population relativement grande.
Le nombre de cas est fortement lié au nombre d'habitant du pays, classons donc les pays par taux de personnes contaminées.
```{r}
cov19 %>% select(confirmed,iso_alpha_3) %>% 
  filter(!is.na(confirmed)) %>% 
  group_by(iso_alpha_3 )%>% 
  summarize(cases=max(confirmed)) %>% 
  left_join(world_bank_pop %>% filter(indicator=="SP.POP.TOTL") %>%select(country,"2017"),by=c("iso_alpha_3"="country")) %>% 
  rename(pop="2017") %>% 
  filter(!is.na(pop)) %>% 
  mutate(prop=cases/pop) %>% 
  arrange(desc(prop)) %>% 
  head(10) %>% 
  ggplot()+geom_col(aes(x=reorder(iso_alpha_3,prop),y=prop))
```

Essayons de voir l'indice de réactivité des gouvernements de ces pays, et de la France pour comparer, face à la pandémie.
```{r}
cov19 %>% filter(iso_alpha_3 %in% c('MDV','CZE','SVN','SVK','GEO','ABW','GIB','SYC','MNE','AND','FRA'),!is.na(government_response_index)) %>% 
  select(iso_alpha_3,government_response_index) %>% 
  group_by(iso_alpha_3) %>% 
  summarize(réactivité=mean(government_response_index))
  
```

On remarque que le jeu de données n'inclut pas l'indice en question pour certains de ces pays. Comme on l'aurait deviné, l'indice de ces pays est en moyenne moins que celui de la France.

Intéressons nous maintenant au classement des pays par rapport à cet indice.

## Classement des 10 pays les plus réactifs en moyenne suite à la pandémie
```{r}
cov19 %>% filter(administrative_area_level==1) %>% 
  select(government_response_index,iso_alpha_3) %>% 
  filter(!is.na(government_response_index)) %>% 
  group_by(iso_alpha_3) %>% 
  summarize(response=mean(government_response_index)) %>% 
  arrange(desc(response)) %>% 
  head(10) %>% 
  ggplot(aes(x=reorder(iso_alpha_3,response),y=response))+geom_col()
  
```

Le gouvernement qui a eu une plus grande réactivité en moyenne est l'Italie qui a eu un début de pandémie très dur. 

# Situation en France

## Évolution des cas et du confinement en fonction du temps en France

```{r}
cov19 %>% filter(iso_alpha_3=='FRA') %>% 
  select(confirmed,stay_home_restrictions,date) %>% 
  filter(!is.na(confirmed),!is.na(stay_home_restrictions)) %>% 
  ggplot(aes(x=date))+geom_line(aes(y=confirmed))+geom_area(aes(y=abs(stay_home_restrictions*1.2e+07)),fill="#9898fb",alpha=0.3)
```

La zone en bleue désigne la période du confinement alors que la zone semi-remplie désigne la période de confinement à restrictions réduites.
On constate que les périodes de confinement sont celles qui ont connues une forte grimpe dans le nombre de cas. On peut le voir d'une manière plus positive : les périodes qu'on a identifié comme nécessitant un confinement se sont bien avérées être dangereuses.

## Réactivité du gouvernement français en fonction du temps 
```{r}
cov19 %>% filter(administrative_area_level==1,iso_alpha_3=='FRA') %>% 
  select(date,government_response_index) %>% 
  filter(!is.na(date),!is.na(government_response_index)) %>% 
  ggplot(aes(y=government_response_index,x=date))+geom_smooth(method = 'loess' , formula= y ~ x)+geom_point()
```


On remarque que la réactivité du gouvernement français a grimpé lors du premier confinement et continue de fluctuer.

## Situation par région

```{r , hide = TRUE}

data_france <- COVID19::covid19("FRA", level = 3, verbose = FALSE)
#Data_geo :
url <- "https://biogeo.ucdavis.edu/data/gadm3.6/gpkg/gadm36_FRA_gpkg.zip"
zip <- tempfile()
download.file(url, destfile = zip)
exdir <- tempfile()
unzip(zip, exdir = exdir)
file <- paste0(exdir, "/gadm36_FRA.gpkg")
```
```{r,results='hide', warning=FALSE, message=FALSE}
g <- st_read(file, layer = "gadm36_FRA_2")
```
```{r}
data_france <- data_france[
  data_france$date == "2021-11-15" ,]
gdata_france <- right_join(g, data_france, by = c("GID_2" = "key_gadm"))
```
```{r}
plot(gdata_france["confirmed"],main="Nombre de cas confirmés en France par département", logz = TRUE)

```



```{r}
plot(gdata_france["population"],main="Nombre d'habitants en France par département", logz = TRUE)
```

La taille de la population est liée au nombre de cas confirmés. Si on va plus loin pour étudier cette corrélation entre le nombre de cas par département et la taille de la population, nous constatons qu'elle est fortement corrélée en France. Mais ce constat n'est pas vrai pour tous les pays. Et c'est ce que nous avons vu auparavant avec des pays comme la Chine.



```{r}

cov19_corr <- select(data_france,population,confirmed,date,iso_alpha_3)  
cov19_corr <- filter(cov19_corr, !is.na(confirmed),!is.na(population))
cov19_corr <- filter(cov19_corr,date == max(date, na.rm = T) - 30)

ggscatter(cov19_corr, x = "population", y = "confirmed", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "La population par département", ylab = "Nombre de cas confirmés")
```

A l'échelle mondiale :

```{r}

cov19_corr <- select(cov19,population,confirmed,date,iso_alpha_3)
cov19_corr <- filter(cov19_corr, !is.na(confirmed),!is.na(population))
cov19_corr <- filter(cov19_corr,date == max(date, na.rm = T) - 30)

ggscatter(cov19_corr, x = "population", y = "confirmed", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Population", ylab = "Nombre de cas confirmés")
```





# Correlations :



Même si nous ne disposons pas de l'âge dans notre base de données, nous pouvons essayer de voir comment il affecte le nombre de décès (sachant que les personnes âgées sont plus susceptibles de mourir que les jeunes, d'après COVID-19). 

La protection des personnes âgées (**elderly_people_protection**)  est un facteur qui est égal à : 0 si aucune mesure n'a été prise. 1 : Mesures d'isolement, d'hygiène et de restriction des visites recommandées. 2 : Restrictions étroites en matière d'isolement, d'hygiène dans les EHPAD, certaines limitations concernant les visiteurs extérieurs et/ou des restrictions protégeant les personnes âgées à domicile. Et 3 : Restrictions étendues en matière d'isolement et d'hygiène dans les EFSLD, interdiction de tous les visiteurs extérieurs non essentiels, et/ou obligation pour toutes les personnes âgées de rester chez elles et de ne pas en sortir, à quelques exceptions près, et de ne recevoir aucun visiteur extérieur. Notez que les valeurs négatives -1, -2, 3 sont utilisées pour identifier les politiques qui représentent la meilleure estimation de la politique en vigueur, mais peuvent ne pas représenter le statut réel. 

```{r}
cov19_corr <- select(cov19,deaths,elderly_people_protection,date,iso_alpha_3)
cov19_corr <- filter(cov19_corr, !is.na(deaths),!is.na(elderly_people_protection))
cov19_corr <- filter(cov19_corr,date == max(date, na.rm = T) - 30)
cov19_corr <- group_by(cov19_corr,elderly_people_protection)
cov19_corr$elderly_people_protection <- as.character(cov19_corr$elderly_people_protection)

box_plot <- ggplot(cov19_corr, aes(x = elderly_people_protection, y = deaths, color = elderly_people_protection))+  scale_y_continuous(limits = quantile(cov19_corr$deaths, c(0.0, 0.8)))

box_plot <- box_plot + geom_boxplot(outlier.shape = NA)  +
    stat_summary(fun= mean,
        geom = "point",
        size = 3,
        color = "steelblue") +
    theme_classic()

box_plot
```

Comme nous pouvons le voir sur le diagramme en boîte, ce qui est associé à un plus grand nombre de décès est le fait d'avoir des restrictions théoriques qui ne sont pas appliquées dans la vie réelle.  Nous pouvons également constater que plus il y a de restrictions, plus il y a de décès. Cela ne signifie pas que les restrictions ne fonctionnent pas, mais que les restrictions sont généralement mises en place après la propagation du virus et lorsque les personnes âgées y sont déjà exposées. Nous pouvons également constater qu'il est préférable d'avoir des restrictions (en moyenne) 1 que de ne pas en avoir. Et généralement, nous ne pouvons pas tirer de conclusions fortes à partir de cela en raison des grandes valeurs aberrantes (outliers).


```{r}

cov19_corr <- select(cov19,deaths,elderly_people_protection,date,iso_alpha_3)
cov19_corr <- filter(cov19_corr, !is.na(deaths),!is.na(elderly_people_protection))
cov19_corr <- filter(cov19_corr,date == max(date, na.rm = T) - 30)
cov19_corr["elderly_people_protection"] <- lapply(cov19_corr["elderly_people_protection"],  abs)
cov19_corr <- group_by(cov19_corr,elderly_people_protection)
cov19_corr$elderly_people_protection <- as.character(cov19_corr$elderly_people_protection)

box_plot <- ggplot(cov19_corr, aes(x = elderly_people_protection, y = deaths, fill=elderly_people_protection))+  scale_y_continuous(limits = quantile(cov19_corr$deaths, c(0.0, 0.85)))

box_plot <- box_plot + geom_boxplot(outlier.shape = NA)  +
    stat_summary(fun= mean,
        geom = "point",
        size = 3,
        color = "steelblue") +
    theme_classic()

box_plot

```



```{r, hide=TRUE}
# Nous aurions pu aller plus loin et appliquer l'ANOVA pour obtenir des résultats statistiques intéressants ici, mais nous n'avons pas les deux conditions nécessaires car les observations ne sont pas indépendantes des niveaux de facteurs et les données ne sont pas normalement distribuées.

res.aov <- aov(deaths ~ elderly_people_protection, data = cov19_corr)
# Summary of the analysis
summary(res.aov)

```



Pour la variable testing_policy , nous avons soit 0 : pas de politique de test, 1 : seulement ceux qui à la fois (a) ont des symptômes ET (b) répondent à des critères spécifiques (par exemple les travailleurs clés, admis à l'hôpital, en contact avec un cas connu, de retour de l'étranger). 2 : dépistage de toute personne présentant des symptômes de Covid-19. 3 : test public ouvert (par exemple, test "drive through" accessible aux personnes asymptomatiques).

```{r}

cov19_corr <- select(cov19,confirmed,testing_policy,date,iso_alpha_3)
cov19_corr <- filter(cov19_corr, !is.na(confirmed),!is.na(testing_policy))
cov19_corr <- filter(cov19_corr,date == max(date, na.rm = T) - 30)
cov19_corr["testing_policy"] <- lapply(cov19_corr["testing_policy"],  abs)
cov19_corr <- group_by(cov19_corr,testing_policy)
cov19_corr$testing_policy <- as.character(cov19_corr$testing_policy)

box_plot <- ggplot(cov19_corr, aes(x = testing_policy, y = confirmed, fill=testing_policy))+  scale_y_continuous(limits = quantile(cov19_corr$confirmed, c(0.0, 0.9)))

box_plot <- box_plot + geom_boxplot(outlier.shape = NA)  +
    stat_summary(fun= mean,
        geom = "point",
        size = 3,
        color = "steelblue") +
    theme_classic()

box_plot

```

Nous pouvons voir qu'il est préférable d'avoir un test public ouvert plutôt qu'un test limité. Mais si nous voyons testing_policy : 0 ou testing_policy :1, cela montre que le nombre de cas confirmés est plus faible. Nous devons faire attention ici au nombre d'éléments dans chaque catégorie. Par exemple, il n'y a qu'un seul pays sans politique de test, et il n'y a que 18 pays dans la catégorie 1. Ainsi, dans ce cas, le nombre de cas est davantage lié à d'autres variables comme la taille de la population, comme nous l'avons vu précédemment. Et dans certains pays avec une politique de test, d'autres restrictions ont été prises, par exemple des restrictions de mouvement interne et international.

```{r}
dt <-  table(cov19_corr$testing_policy)

dt

dt  %>%
  kbl() %>%
  kable_styling()
```





# Conclusions

- On constate l'effet de la vaccination sur nos données.
- La maladie du COVID a une mortalité realtivement réduite mais est dangereuse dans son effet de propagation.
- Le nombre de cas diffère d'un pays à l'autre en fonction des mesures prises par les gouvernements.
- Le confinement en France a été en vigueur pendant les périodes les plus dangereuses dans la propagation du virus.
- Le gouvernement français reste toujours réactif face à la pandémie.
